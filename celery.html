<!DOCTYPE html>
<html lang="fr">

<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="canonical" href="http://dotmobo.github.io/celery.html" />

    <title>  .mobo &mdash; Découverte du gestionnaire de files de tâches Celery
</title>



      <link type="application/atom+xml" rel="alternate" href="/feeds/all.atom.xml"  title=".mobo Atom Feed">

    <link rel="stylesheet" href="http://dotmobo.github.io/theme/css/style.css">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-68852219-1', 'auto');
    ga('send', 'pageview');

  </script>

    <meta name="author" content="Morgan">
    <meta name="description" content="Découverte du gestionnaire de files de tâches Celery">
  <meta name="tags" contents="rabbitmq, message broker, python, celery, tâches, jobs, ">
</head>

<body>
<header class="header">
  <div class="container">
      <div class="header-image pull-left">
        <a class="nodec" href="http://dotmobo.github.io"><img src=https://pbs.twimg.com/profile_images/559712938420760577/Hraa9PBv_200x200.jpeg></a>
      </div>
    <div class="header-inner">
      <h1 class="header-name">
        <a class="nodec" href="http://dotmobo.github.io">.mobo</a>
      </h1>
      <h3 class="header-text">Blog d'un Pythoniste Djangonaute</h3>
      <ul class="header-menu list-inline">
          <li><a class="nodec" href="http://dotmobo.github.io/categories.html">Cat&eacute;gories</a></li>
          <li class="muted">|</li>
          <li><a class="nodec" href="http://dotmobo.github.io/tags.html">Tags</a></li>
          <li class="muted">|</li>
          <li><a class="nodec" href="http://dotmobo.github.io/archives.html">Archives</a></li>
          <li class="muted">|</li>
          <li><a class="nodec icon-github" href="https://github.com/dotmobo"></a></li>
          <li><a class="nodec icon-twitter" href="https://twitter.com/dotmobo"></a></li>
          <li><a class="nodec icon-gplus" href="https://www.google.com/+DotmoboGithubIo6"></a></li>
          <li><a class="nodec icon-rss" href="/feeds/all.atom.xml"></a></li>
      </ul>
    </div>
  </div>
</header> <!-- /.header -->  <div class="container">
  <div class="post full-post">
    <h1 class="post-title">
      <a href="/celery.html" title="Permalink to Découverte du gestionnaire de files de tâches Celery">Découverte du gestionnaire de files de tâches Celery</a>
    </h1>
    <ul class="list-inline">
      <li class="post-date">
        <a class="text-muted" href="/celery.html" title="2017-09-28T00:00:00+02:00">jeu. 28 septembre 2017</a>
      </li>
      <li class="muted">&middot;</li>
      <li class="post-category">
        <a href="http://dotmobo.github.io/category/django.html">Django</a>
      </li>
        <li class="muted">&middot;</li>
        <li>
            <a href="/tag/rabbitmq.html">rabbitmq</a>,             <a href="/tag/message broker.html">message broker</a>,             <a href="/tag/python.html">python</a>,             <a href="/tag/celery.html">celery</a>,             <a href="/tag/tâches.html">tâches</a>,             <a href="/tag/jobs.html">jobs</a>        </li>
    </ul>
    <div class="post-content">
      <img alt="RabbitMQ" class="align-right" src="./images/celery.png" />
<p><strong>C'est quoi ? Ça se mange ?</strong></p>
<p><a class="reference external" href="http://www.celeryproject.org/">Celery</a> est un gestionnaire de tâches <em>asynchrone</em>.
Il s'occupe de créer des files d'attentes pour les tâches, de les distribuer sur un ou des <em>workers</em> et
d'en répartir la charge. Intégré dans une application web, il va permettre d'ordonner l'exécution de tâches
en background.</p>
<p>Cet outil va t'être utile dans de nombreux cas d'usages. Personnellement, je l'utilise pour une application de streaming
de vidéos et il me permet de lancer les jobs d'encodage des médias sur différents serveurs.</p>
<p>Mais tu vas pouvoir lui laisser le soin de zipper/dézipper de gros fichiers, générer de nombreux documents pdf, lancer
le téléchargement de fichiers en masse ou encore lancer des calculs sur plusieurs machines.</p>
<p><strong>Mais pourquoi utiliser Celery et pas un autre outil ?</strong></p>
<p>Déjà, il est mature et très utilisé dans la communauté Python. Son côté <em>asynchrone</em> lui donne de bonnes performances.
De plus, il en existe une intégration dans Django. Il y a des clients implémentés dans d'autres languages, comme php ou node.
Grâce à lui, tu vas pouvoir automatiser tout un tas de trucs en répartissant les <em>workers</em> et les clients sur différentes machines.</p>
<p><strong>Broker, quésaco ?</strong></p>
<p>La première notion à connaître est le <strong>broker</strong>. Il s'agit tout simplement de la file d'attente.
Tu vas pouvoir utiliser plusieurs technos pour gérer le <em>broker</em>, comme RabbitMq, Redis, Mongodb, Sqlalchemy, ou même l'orm de Django.</p>
<p>C'est le <em>broker</em> qui va permettre la communication entre le(s) workers(s) et le(s) client(s). La techno recommandée par Celery est <a class="reference external" href="https://www.rabbitmq.com/">RabbitMq</a>,
qui utilise le protocole <strong>AMQP</strong>. Je t'en ai <a class="reference external" href="http://dotmobo.github.io/rabbitmq.html">déjà parlé précédemment</a>.</p>
<p><strong>Backend, quésaco ?</strong></p>
<p>La seconde notion à connaître est le <strong>backend</strong>. Celui-ci est optionnel et permet de monitorer et de garder une trace des états des tâches.
Les options de stockage sont quasi-similaires à celle du broker (RabbitMq, Redis, etc ...)</p>
<p><strong>Mon application web qui génère des archives AVANT Celery</strong></p>
<p>Prenons l'exemple d'une petite application web qui a pour objectif de générer un document au format pdf pour chaque usager présent dans une base de
données, par année de naissance.</p>
<ul class="simple">
<li>Étape 1 : choisir une année de naissance</li>
<li>Étape 2 : cliquer sur &quot;Générer&quot;</li>
<li>Étape 3 : regarder la roue qui tourne <img alt="waiting" src="./images/loading.gif" /></li>
<li>Étape 4 : se faire un café</li>
<li>Étape 5 : contempler la roue qui tourne</li>
<li>Étape 6 : se faire un autre café</li>
<li>Étape 7 : 504 Gateway Timeout</li>
</ul>
<p><strong>Mon application web qui génère des archives AVEC Celery</strong></p>
<ul class="simple">
<li>Étape 1 : choisir une année de naissance</li>
<li>Étape 2 : cliquer sur &quot;Générer&quot;</li>
<li>Étape 3 : choisir une autre année</li>
<li>Étape 4 : cliquer sur &quot;Générer&quot;</li>
<li>Étape 5 : choisir une autre année</li>
<li>Étape 6 : cliquer sur &quot;Générer&quot;</li>
<li>Étape 7: Mince, il est où mon café ?</li>
</ul>
<p><strong>Objectif</strong></p>
<p>Pour se faire, l'objectif est d'arriver à une architecture de ce type:</p>
<p><img alt="objectif" src="./images/django_celery_architecture.png" /></p>
<p><strong>Installation</strong></p>
<p>Tu commences par installer RabbitMq:</p>
<ul class="simple">
<li>Soit sous Ubuntu (tu prends la dernière version ici):</li>
</ul>
<div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s1">&#39;deb http://www.rabbitmq.com/debian/ testing main&#39;</span> <span class="p">|</span> sudo tee /etc/apt/sources.list.d/rabbitmq.list
wget -O- https://www.rabbitmq.com/rabbitmq-release-signing-key.asc <span class="p">|</span> sudo apt-key add -
sudo apt-get update <span class="o">&amp;&amp;</span> apt-get install rabbitmq-server
</pre></div>
<ul class="simple">
<li>Soit via Docker:</li>
</ul>
<div class="highlight"><pre><span></span>docker run -d --hostname myrabbitmq --name myrabbitmq -p 5672:5672 rabbitmq:3
</pre></div>
<p>Puis tu installes Celery avec pip:</p>
<div class="highlight"><pre><span></span>pip install <span class="nv">celery</span><span class="o">==</span>3.1.25
</pre></div>
<p>Oui je sais, il y a la version 4.1 de Celery qui est sortie cet été. Mais je n'ai pas encore eu le temps de me pencher dessus, donc il
faudra sûrement mettre à jour ce tuto à l'avenir ! Désolé mon vieux !</p>
<p><strong>Django - Configuration</strong></p>
<p>Dans ton fichier de <em>settings</em> de django, par exemple <em>myproject/settings.py</em>, tu ajoutes les paramètres suivants:</p>
<div class="highlight"><pre><span></span><span class="n">CELERY_NAME</span> <span class="o">=</span> <span class="s2">&quot;myproject&quot;</span>
<span class="n">CELERY_BACKEND</span> <span class="o">=</span> <span class="s2">&quot;amqp&quot;</span>
<span class="n">CELERY_BROKER</span> <span class="o">=</span> <span class="s2">&quot;amqp://guest@localhost//&quot;</span>
</pre></div>
<p><strong>Django - Worker</strong></p>
<p>Ensuite, tu crées ton worker <em>myproject/celery.py</em>:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;DJANGO_SETTINGS_MODULE&quot;</span><span class="p">,</span> <span class="s2">&quot;myproject.settings&quot;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CELERY_NAME</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">CELERY_BACKEND</span>
    <span class="n">broker</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">CELERY_BROKER</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">config_from_object</span><span class="p">(</span><span class="s1">&#39;django.conf:settings&#39;</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">autodiscover_tasks</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">INSTALLED_APPS</span><span class="p">)</span>

<span class="nd">@app.task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">debug_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Request: {0!r}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">))</span>
</pre></div>
<p><strong>Django - Création des tâches</strong></p>
<p>Puis, tu crées les tâches qui vont te permettre de générer les documents pdf dans <em>myproject/apps/myapp/tasks.py</em>:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">shared_task</span>
<span class="kn">from</span> <span class="nn">celery.signals</span> <span class="kn">import</span> <span class="n">task_prerun</span><span class="p">,</span> <span class="n">task_success</span><span class="p">,</span> <span class="n">task_failure</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">get_persons_and_generate_pdfs</span>

<span class="nd">@shared_task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># utile pour les &quot;reusable apps&quot;</span>
<span class="k">def</span> <span class="nf">task_generate_archive_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; generate pdf files &quot;&quot;&quot;</span>
    <span class="n">get_persons_and_generate_pdfs</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>

<span class="nd">@task_prerun.connect</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">task_generate_archive_files</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">start_generate_archive_files</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Initialisation du statut du lot en base&quot;</span><span class="p">)</span>

<span class="nd">@task_success.connect</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">task_generate_archive_files</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">success_generate_archive_files</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Modification du statut du lot en réussi&quot;</span><span class="p">)</span>

<span class="nd">@task_failure.connect</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">task_generate_archive_files</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">failure_generate_archive_files</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Modification du statut du lot en échec&quot;</span><span class="p">)</span>
</pre></div>
<p><strong>Django - Appel des tâches</strong></p>
<p>Enfin, tu gères l'appelles des tâches dans <em>myproject/apps/myapp/views.py</em>, par exemple:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.tasks</span> <span class="kn">import</span> <span class="n">task_generate_archive_files</span>

<span class="nd">@login_required</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">generate_archive_files</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;birth_date&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">my_task</span> <span class="o">=</span> <span class="n">task_generate_archive_files</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">IntegrityError</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;A file for one of those persons already exists&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;A file creation task is scheduled&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;myproject-database:database&quot;</span><span class="p">,</span> <span class="s2">&quot;?birth_date={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">()</span>
</pre></div>
<p>À toi d'adapter le code pour que ça colle avec ton projet, tes urls, et autres. C'est qu'un exemple d'utilisation.</p>
<p><strong>Django - Exécution</strong></p>
<p>Pour exécuter celery, tu peux alors lancer la commande suivante:</p>
<div class="highlight"><pre><span></span>celery -A myproject worker -l info
</pre></div>
<p>Tu peux même te faire un petit <strong>Makefile</strong> dans ce genre:</p>
<div class="highlight"><pre><span></span>RABBITMQ :<span class="o">=</span> rabbitmq-myproject
CELERY :<span class="o">=</span> myproject

run-rabbitmq:
    docker ps -aq --filter <span class="nv">name</span><span class="o">=</span><span class="k">$(</span>RABBITMQ<span class="k">)</span> <span class="p">|</span> xargs -r docker rm -f -v <span class="o">&amp;&amp;</span> <span class="se">\</span>
    docker run -d --hostname <span class="k">$(</span>RABBITMQ<span class="k">)</span> --name <span class="k">$(</span>RABBITMQ<span class="k">)</span> -p 5672:5672 rabbitmq:3

run-celery: run-rabbitmq
    celery -A <span class="k">$(</span>CELERY<span class="k">)</span> worker -l info

.PHONY: un-rabbitmq run-celery
</pre></div>
<p><strong>Debug</strong></p>
<p>Tu vas alors avoir un écran de debug qui ressemble à ça:</p>
<div class="highlight"><pre><span></span><span class="o">[</span>2016-10-21 16:47:18,568: INFO/MainProcess<span class="o">]</span> Connected to amqp://guest:**@127.0.0.1:5672//
<span class="o">[</span>2016-10-21 16:47:18,615: INFO/MainProcess<span class="o">]</span> mingle: searching <span class="k">for</span> neighbors
<span class="o">[</span>2016-10-21 16:47:19,628: INFO/MainProcess<span class="o">]</span> mingle: all alone
<span class="o">[</span>2016-10-21 16:50:23,354: INFO/MainProcess<span class="o">]</span> Received task: myproject.apps.file.
tasks.task_generate_archive_files<span class="o">[</span>1755cd30-03f5-4d8a-8d92-fa5b1853a209<span class="o">]</span>
...
...
...
<span class="o">[</span>2016-10-21 16:50:26,944: INFO/MainProcess<span class="o">]</span> Task myproject.apps.file.
tasks.task_generate_archive_files<span class="o">[</span>1755cd30-03f5-4d8a-8d92-fa5b1853a209<span class="o">]</span>
succeeded in 3.588768539018929s: <span class="s1">&#39;1755cd30-03f5-4d8a-8d92-fa5b1853a209&#39;</span>
</pre></div>
<p><strong>Tests unitaires</strong></p>
<p>Pour lancer des tests unitaires sur tes tâches dans ton projet Django, tu peux utiliser le paramètre suivant dans tes <em>settings</em>:</p>
<div class="highlight"><pre><span></span><span class="n">CELERY_ALWAYS_EAGER</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
<p>Ça permet de tester les tâches Celery de manière synchrone et sans <em>broker</em> (il utilise un genre de <em>broker</em> en mémoire).</p>
<p><strong>Déploiement avec init.d</strong></p>
<p>Il existe <a class="reference external" href="https://github.com/celery/celery/tree/master/extra">un dépôt d'helpers</a> pour déployer avec init.d ou systemd. Par exemple pour init.d :</p>
<ul class="simple">
<li>Mettre le fichier <em>celeryd</em> du dépôt d'<em>helpers</em> dans <em>/etc/init.d</em>.</li>
<li>Mettre la configuration suivante dans /etc/default/celeryd:</li>
</ul>
<div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">DJANGO_SETTINGS_MODULE</span><span class="o">=</span><span class="s2">&quot;myproject.settings&quot;</span>

<span class="nv">CELERYD_NODES</span><span class="o">=</span><span class="s2">&quot;worker1&quot;</span>
<span class="nv">CELERY_BIN</span><span class="o">=</span><span class="s2">&quot;/home/myuser/.virtualenvs/myproject/bin/celery&quot;</span>
<span class="nv">CELERY_APP</span><span class="o">=</span><span class="s2">&quot;myproject&quot;</span>
<span class="nv">CELERYD_CHDIR</span><span class="o">=</span><span class="s2">&quot;/home/myuser/myproject&quot;</span>
<span class="nv">CELERYD_OPTS</span><span class="o">=</span><span class="s2">&quot;--time-limit=300 --concurrency=8&quot;</span>
<span class="nv">CELERYD_LOG_FILE</span><span class="o">=</span><span class="s2">&quot;/var/log/celery/%N.log&quot;</span>
<span class="nv">CELERYD_PID_FILE</span><span class="o">=</span><span class="s2">&quot;/var/run/celery/%N.pid&quot;</span>
<span class="nv">CELERYD_USER</span><span class="o">=</span><span class="s2">&quot;myuser&quot;</span>
<span class="nv">CELERYD_GROUP</span><span class="o">=</span><span class="s2">&quot;mygroup&quot;</span>
<span class="nv">CELERY_CREATE_DIRS</span><span class="o">=</span>1
</pre></div>
<p><strong>Monitoring - Exemples</strong></p>
<ul class="simple">
<li>Voir le résultat d'une tâche :</li>
</ul>
<div class="highlight"><pre><span></span>celery -A myproject result -t tasks.add 4e196aa4-0141-4601-8138-7aa33db0f577
</pre></div>
<ul class="simple">
<li>Voir liste des workers actifs :</li>
</ul>
<div class="highlight"><pre><span></span>celery -A myproject status
</pre></div>
<ul class="simple">
<li>Voir les tâches actives :</li>
</ul>
<div class="highlight"><pre><span></span>celery -A myproject inspect active
</pre></div>
<ul class="simple">
<li>Voir les statistiques des workers :</li>
</ul>
<div class="highlight"><pre><span></span>celery -A myproject inspect stats
</pre></div>
<ul class="simple">
<li>Sinon, il existe le projet <a class="reference external" href="https://github.com/mher/flower">flower</a> pour monitorer et administrer les workers et les tâches via une appli web.</li>
</ul>
<p><strong>En vrac</strong></p>
<p>Quelques tips en vrac:</p>
<ul class="simple">
<li>Cron-like :</li>
</ul>
<div class="highlight"><pre><span></span>@periodic_task<span class="o">(</span><span class="nv">run_every</span><span class="o">=</span>crontab<span class="o">(</span><span class="nv">hour</span><span class="o">=</span><span class="s1">&#39;5,13,23&#39;</span>, <span class="nv">minute</span><span class="o">=</span>30, <span class="nv">day_of_week</span><span class="o">=</span><span class="s1">&#39;monday&#39;</span><span class="o">))</span>
def mytask<span class="o">()</span>:
...
</pre></div>
<ul class="simple">
<li>Sqlite n'aime pas les accès concurrents</li>
<li>Purger les tâches en attentes :</li>
</ul>
<div class="highlight"><pre><span></span>celery -A proj purge
</pre></div>
<ul class="simple">
<li>Récupérer le statut d'une tâche :</li>
</ul>
<div class="highlight"><pre><span></span><span class="nv">result</span> <span class="o">=</span> my_task.AsyncResult<span class="o">(</span>task_id<span class="o">)</span>
result.state
</pre></div>
<ul class="simple">
<li>Attendre le résultat d'une tâche :</li>
</ul>
<div class="highlight"><pre><span></span><span class="nv">result</span> <span class="o">=</span> my_task.AsyncResult<span class="o">(</span>task_id<span class="o">)</span>
result.get<span class="o">()</span>
</pre></div>
<ul class="simple">
<li>Appeler une tâche par son nom depuis une autre machine :</li>
</ul>
<div class="highlight"><pre><span></span>from celery import Celery
<span class="nv">celery</span> <span class="o">=</span> Celery<span class="o">()</span>
celery.config_from_object<span class="o">(</span><span class="s1">&#39;celeryconfig&#39;</span><span class="o">)</span>
celery.send_task<span class="o">(</span><span class="s1">&#39;tasks.add&#39;</span>, <span class="o">(</span>2,2<span class="o">))</span>
</pre></div>
<ul class="simple">
<li>Appeler une tâches via HTTP :</li>
</ul>
<div class="highlight"><pre><span></span>from celery.task.http import URL
<span class="nv">res</span> <span class="o">=</span> URL<span class="o">(</span><span class="s1">&#39;http://example.com/multiply&#39;</span><span class="o">)</span>.get_async<span class="o">(</span><span class="nv">x</span><span class="o">=</span>10, <span class="nv">y</span><span class="o">=</span>10<span class="o">)</span>
</pre></div>
<ul class="simple">
<li>On peut appeler une tâche dans une tâche !</li>
<li>Pour l'optimisation, la sécurité, les extensions, la concurrence, voir la <a class="reference external" href="http://docs.celeryproject.org/en/latest/index.html">doc officielle</a>.</li>
</ul>

    </div>
  </div>
  <hr class="separator">
  <div class="col-md-8 col-md-offset-2">
  <div id="disqus_thread">
    <script>
      var disqus_shortname = 'dotmobo';
      (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] ||
         document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>
      Activez Javascript pour voir 
      <a href="https://disqus.com/?ref_noscript=dotmobo">
        les commentaires Disqus.
      </a>
    </noscript>
    <a href="https://disqus.com" class="dsq-brlink">
      Commentaires de blog par <span class="logo-disqus">Disqus</span>
    </a>
  </div>
  </div>
  </div>
<footer class="footer">
  <div class="container">
    <p class="text-center">
      dotmobo, <a href="https://opensource.org/licenses/MIT" target="_blank">MIT</a>.
    </p>
    <div class="text-center">
      G&eacute;n&eacute;r&eacute; par <a href="http://getpelican.com" target="_blank">Pelican</a> avec le th&egrave;me <a href="https://github.com/dotmobo/pelican-alchemy">alchemy</a>.
    </div>
  </div>
</footer> <!-- /.footer -->
  <script src="http://dotmobo.github.io/theme/js/jquery.min.js"></script>
  <script src="http://dotmobo.github.io/theme/js/bootstrap.min.js"></script>
</body> <!-- 42 -->

</html>