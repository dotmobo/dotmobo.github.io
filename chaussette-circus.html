<!DOCTYPE html>
<html lang="fr">

<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="canonical" href="http://dotmobo.github.io/chaussette-circus.html" />

    <title>  .mobo &mdash; Servir une application web python avec chaussette, circus et nginx
</title>



      <link type="application/atom+xml" rel="alternate" href="/feeds/all.atom.xml"  title=".mobo Atom Feed">

    <link rel="stylesheet" href="http://dotmobo.github.io/theme/css/style.css">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-68852219-1', 'auto');
    ga('send', 'pageview');

  </script>

    <meta name="author" content="Morgan">
    <meta name="description" content="Servir une application web python avec chaussette, circus et nginx">
  <meta name="tags" contents="python, circus, chaussette, nginx, django, bottle, flask, mozilla, waitress, ">
</head>

<body>
<header class="header">
  <div class="container">
      <div class="header-image pull-left">
        <a class="nodec" href="http://dotmobo.github.io"><img src=https://pbs.twimg.com/profile_images/559712938420760577/Hraa9PBv_200x200.jpeg></a>
      </div>
    <div class="header-inner">
      <h1 class="header-name">
        <a class="nodec" href="http://dotmobo.github.io">.mobo</a>
      </h1>
      <h3 class="header-text">Blog d'un Pythoniste Djangonaute</h3>
      <ul class="header-menu list-inline">
          <li><a class="nodec" href="http://dotmobo.github.io/categories.html">Cat&eacute;gories</a></li>
          <li class="muted">|</li>
          <li><a class="nodec" href="http://dotmobo.github.io/tags.html">Tags</a></li>
          <li class="muted">|</li>
          <li><a class="nodec" href="http://dotmobo.github.io/archives.html">Archives</a></li>
          <li class="muted">|</li>
          <li><a class="nodec icon-github" href="https://github.com/dotmobo"></a></li>
          <li><a class="nodec icon-twitter" href="https://twitter.com/dotmobo"></a></li>
          <li><a class="nodec icon-gplus" href="https://www.google.com/+DotmoboGithubIo6"></a></li>
          <li><a class="nodec icon-rss" href="/feeds/all.atom.xml"></a></li>
      </ul>
    </div>
  </div>
</header> <!-- /.header -->  <div class="container">
  <div class="post full-post">
    <h1 class="post-title">
      <a href="/chaussette-circus.html" title="Permalink to Servir une application web python avec chaussette, circus et nginx">Servir une application web python avec chaussette, circus et nginx</a>
    </h1>
    <ul class="list-inline">
      <li class="post-date">
        <a class="text-muted" href="/chaussette-circus.html" title="2016-04-09T00:00:00+02:00">sam. 09 avril 2016</a>
      </li>
      <li class="muted">&middot;</li>
      <li class="post-category">
        <a href="http://dotmobo.github.io/category/python.html">Python</a>
      </li>
        <li class="muted">&middot;</li>
        <li>
            <a href="/tag/python.html">python</a>,             <a href="/tag/circus.html">circus</a>,             <a href="/tag/chaussette.html">chaussette</a>,             <a href="/tag/nginx.html">nginx</a>,             <a href="/tag/django.html">django</a>,             <a href="/tag/bottle.html">bottle</a>,             <a href="/tag/flask.html">flask</a>,             <a href="/tag/mozilla.html">mozilla</a>,             <a href="/tag/waitress.html">waitress</a>        </li>
    </ul>
    <div class="post-content">
      <img alt="Chaussette" class="align-right" src="./images/chaussette.png" />
<p>Voilà, tu as enfin développé ton application django/bottle/flask (raye les
mentions inutiles) et tu es fin prêt à la rendre disponible au monde entier.</p>
<p><em>Mais comment faire ? Quel serveur wsgi utiliser ? A l'aide !</em></p>
<p>Il existe différentes alternatives, mais je vais te proposer celle que j'affectionne
tout particulièrement, à savoir le trio chaussette/circus/nginx.</p>
<div class="section" id="creer-une-application-web">
<h2>1) Créer une application web</h2>
<p>Tu vas commencer par créer une application <a class="reference external" href="http://bottlepy.org/">bottle</a>
de base (pour changer de django, tiens !).</p>
<p>Tu crées et actives un environnement virtuel <strong>myapp</strong> en python 3.5 à l'aide de
<em>virtualenvwrapper</em>:</p>
<div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="n">myproject</span> <span class="o">&amp;&amp;</span> <span class="n">cd</span> <span class="n">myproject</span>
<span class="n">mkvirtualenv</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span> <span class="n">myapp</span>
</pre></div>
<p>Tu installes bottle dans ton virtualenv:</p>
<div class="highlight"><pre><span></span>pip install bottle
</pre></div>
<p>Dans le répertoire de ton projet, tu crées un module python <strong>myapp</strong> qui contient
un fichier vide <strong>__init__.py</strong> et un fichier <strong>wsgi.py</strong>:</p>
<div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="n">myapp</span> <span class="o">&amp;&amp;</span> <span class="n">touch</span> <span class="n">myapp</span><span class="o">/</span><span class="n">__init__</span><span class="o">.</span><span class="n">py</span> <span class="n">myapp</span><span class="o">/</span><span class="n">wsgi</span><span class="o">.</span><span class="n">py</span>
</pre></div>
<p>Ton fichier <strong>wsgi.py</strong> doit ressembler à ça:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">default_app</span>

<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/hello/&lt;name&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;&lt;b&gt;Hello {{name}}&lt;/b&gt;!&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

<span class="n">application</span> <span class="o">=</span> <span class="n">default_app</span><span class="p">()</span>
</pre></div>
<p>Pour information, sous django, le fichier à utiliser s'appelle aussi <strong>wsgi.py</strong>.</p>
</div>
<div class="section" id="installer-chaussette-et-waitress">
<h2>2) Installer chaussette et waitress</h2>
<p>Maintenant, tu vas utiliser <a class="reference external" href="https://chaussette.readthedocs.org">chaussette</a>
pour lancer ton application web.</p>
<p>Chaussette est <a class="reference external" href="http://sametmax.com/quest-ce-que-wsgi-et-a-quoi-ca-sert/">un serveur wsgi</a>
qui permet le dialogue entre les requêtes http et ton application python.
Il autorise l'utilisation de différents backends wsgi, comme
<a class="reference external" href="http://waitress.readthedocs.org/">waitress</a> par exemple,
et a également la particularité de pouvoir servir ton application sur un socket déjà
ouvert. Dis comme ça, ça n'a l'air de rien, mais ça permet du coup d'utiliser un
manager de sockets comme circus ou supervisor.</p>
<p>Tu installes chaussette et waitress en étant <strong>dans</strong> le virtualenv <strong>myapp</strong>:</p>
<div class="highlight"><pre><span></span>pip install chaussette waitress
</pre></div>
<p>Et tu lances ton serveur wsgi depuis le répertoire de ton projet <strong>myproject</strong>:</p>
<div class="highlight"><pre><span></span>chaussette --backend waitress myapp.wsgi.application
</pre></div>
<p>Rends-toi sur <a class="reference external" href="http://127.0.0.1:8080/hello/you">http://127.0.0.1:8080/hello/you</a>,
tu devrais voir ta page apparaître. Si tout est ok, tu peux couper chaussette et
passer à la suite.</p>
</div>
<div class="section" id="configurer-circus">
<h2>3) Configurer circus</h2>
<p>Place au spectacle !</p>
<p><a class="reference external" href="http://circus.readthedocs.org/">Circus</a> est, grosso-modo, un manager de processus
et de sockets compatible python 2 et python 3. C'est lui qui va se charger de
monitorer et de redémarrer tes applications.
Il permet d'utiliser les virtualenvs et se marie très bien
avec chaussette. Ce projet nous vient à l'origine de la
<a class="reference external" href="https://www.mozilla.org/en-US/foundation/">fondation mozilla</a>.</p>
<p>Tu l'installes via pip <strong>en dehors</strong> du virtualenv <strong>myapp</strong> (donc en global sur ton système):</p>
<div class="highlight"><pre><span></span>deactivate
apt-get install libzmq-dev libevent-dev
pip install circus
</pre></div>
<p>Et tu crées le fichier de configuration de circus <strong>circus.ini</strong> dans ton <em>home</em>
par exemple. C'est là que tu vas pouvoir configurer tes <em>watchers</em>, qui vont
lancer tes processus chaussette.</p>
<p>Dans le fichier <strong>~/circus.ini</strong>, tu mets:</p>
<div class="highlight"><pre><span></span><span class="o">[</span>circus<span class="o">]</span>
<span class="nv">statsd</span> <span class="o">=</span> 1
<span class="nv">httpd</span> <span class="o">=</span> 0

<span class="o">[</span>watcher:myapp<span class="o">]</span>
<span class="nv">cmd</span> <span class="o">=</span> /home/TONUSER/.virtualenvs/myapp/bin/chaussette --fd <span class="k">$(</span>circus.sockets.web<span class="k">)</span> --backend waitress myapp.wsgi.application
<span class="nv">working_dir</span> <span class="o">=</span> /home/TONUSER/LECHEMINVERSTONPROJET/myproject
<span class="nv">numprocesses</span> <span class="o">=</span> 3
<span class="nv">copy_env</span> <span class="o">=</span> 1
<span class="nv">use_sockets</span> <span class="o">=</span> 1
<span class="nv">virtualenv</span> <span class="o">=</span> /home/TONUSER/.virtualenvs/myapp
<span class="nv">virtualenv_py_ver</span> <span class="o">=</span> 3.5

<span class="o">[</span>socket:web<span class="o">]</span>
<span class="nv">host</span> <span class="o">=</span> 127.0.0.1
<span class="nv">port</span> <span class="o">=</span> 8001
</pre></div>
<p>N'oublie pas de modifier les différents chemins de <strong>working_dir</strong>, <strong>cmd</strong> et
<strong>virtualenv</strong> pour que ça correspondent à ta propre machine. Tu peux également
configurer plusieurs <em>watchers</em> si tu souhaites monitorer plusieurs applications
web.</p>
<p>Enfin, tu lances le <em>daemon</em> de circus:</p>
<div class="highlight"><pre><span></span>circusd --daemon ~/circus.ini
</pre></div>
<p>Si tout s'est bien passé, tu devrais pouvoir utiliser la commande <strong>circusctl</strong>
pour voir le statut de tes applications, les redémarrer et autres.
Sinon, tu peux exécuter <strong>circusd</strong> sans l'option <strong>--daemon</strong> pour debugger.</p>
<p>Tu peux voir ci-dessous quelques exemples d'utilisation de <strong>circusctl</strong>:</p>
<div class="highlight"><pre><span></span>circusctl --help <span class="c1"># voir l&#39;ensemble des commandes disponibles</span>
circusctl status <span class="c1"># voir le statut des applications</span>
circusctl listsockets <span class="c1"># lister les sockets utilisés par les applications</span>
circusctl restart myapp <span class="c1"># redémarrer myapp</span>
circusctl reload myapp <span class="c1"># recharcher la configuration du watcher myapp</span>
</pre></div>
<p>Rends-toi sur <a class="reference external" href="http://127.0.0.1:8001/hello/you">http://127.0.0.1:8001/hello/you</a>
pour vérifier que tout fonctionne.</p>
<p>Grâce à circus, tu peux désormais manager plusieurs applications différentes,
qui tournent sous des environnements virtuels différents.</p>
<p>Pour information, il existe une interface web pour monitorer circus appelé
<strong>circus-web</strong>, mais qui n'est pas encore compatible python 3.</p>
</div>
<div class="section" id="parametrer-nginx">
<h2>3) Paramétrer nginx</h2>
<p>Bon, il ne te reste plus qu'à mettre en place nginx. C'est un
serveur http libre et performant qui est une très bonne alternative à apache.
Il va nous permettre de transmettre les requêtes http à circus/chaussette via les
sockets.</p>
<p>Tu l'installes via <em>apt-get</em> par exemple:</p>
<div class="highlight"><pre><span></span>apt-get install nginx
</pre></div>
<p>Et tu vas créer la configuration suivante dans <strong>/etc/nginx/sites-available/myapp.conf</strong>:</p>
<div class="highlight"><pre><span></span>upstream myapp  <span class="o">{</span>
    server 127.0.0.1:8001<span class="p">;</span>
<span class="o">}</span>
server <span class="o">{</span>
    listen 80<span class="p">;</span>
    server_name localhost<span class="p">;</span>

    location / <span class="o">{</span>
        proxy_pass      http://myapp<span class="nv">$request_uri</span><span class="p">;</span>
        proxy_redirect  off<span class="p">;</span>
        proxy_set_header   Host             <span class="nv">$host</span><span class="p">;</span>
        proxy_set_header   X-Real-IP        <span class="nv">$remote_addr</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>Tu actives ta conf', tu supprimes le site par défaut et tu redémarres nginx:</p>
<div class="highlight"><pre><span></span>ln -s /etc/nginx/sites-available/myapp.conf /etc/nginx/sites-enabled/myapp
rm /etc/nginx/sites-enabled/default
service nginx restart <span class="c1">#ou via systemd selon ta distro</span>
</pre></div>
<p>Il ne te reste plus qu'à te rendre sur <a class="reference external" href="http://localhost/hello/you">http://localhost/hello/you</a> pour observer le résultat !</p>
</div>

    </div>
  </div>
  <hr class="separator">
  <div class="col-md-8 col-md-offset-2">
  <div id="disqus_thread">
    <script>
      var disqus_shortname = 'dotmobo';
      (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] ||
         document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>
      Activez Javascript pour voir 
      <a href="https://disqus.com/?ref_noscript=dotmobo">
        les commentaires Disqus.
      </a>
    </noscript>
    <a href="https://disqus.com" class="dsq-brlink">
      Commentaires de blog par <span class="logo-disqus">Disqus</span>
    </a>
  </div>
  </div>
  </div>
<footer class="footer">
  <div class="container">
    <p class="text-center">
      dotmobo, <a href="https://opensource.org/licenses/MIT" target="_blank">MIT</a>.
    </p>
    <div class="text-center">
      G&eacute;n&eacute;r&eacute; par <a href="http://getpelican.com" target="_blank">Pelican</a> avec le th&egrave;me <a href="https://github.com/dotmobo/pelican-alchemy">alchemy</a>.
    </div>
  </div>
</footer> <!-- /.footer -->
  <script src="http://dotmobo.github.io/theme/js/jquery.min.js"></script>
  <script src="http://dotmobo.github.io/theme/js/bootstrap.min.js"></script>
</body> <!-- 42 -->

</html>