<!DOCTYPE html>
<html lang="fr">

<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="canonical" href="http://dotmobo.github.io/django-simple-captcha.html" />

    <title>  .mobo &mdash; Ajouter un captcha dans un formulaire django
</title>



      <link type="application/atom+xml" rel="alternate" href="/feeds/all.atom.xml"  title=".mobo Atom Feed">

    <link rel="stylesheet" href="http://dotmobo.github.io/theme/css/style.css">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-68852219-1', 'auto');
    ga('send', 'pageview');

  </script>

    <meta name="author" content="Morgan">
    <meta name="description" content="Ajouter un captcha dans un formulaire django">
  <meta name="tags" contents="python, django, django-simple-captcha, captcha, crispy, django-crispy, recaptcha, ">
</head>

<body>
<header class="header">
  <div class="container">
      <div class="header-image pull-left">
        <a class="nodec" href="http://dotmobo.github.io"><img src=https://pbs.twimg.com/profile_images/559712938420760577/Hraa9PBv_200x200.jpeg></a>
      </div>
    <div class="header-inner">
      <h1 class="header-name">
        <a class="nodec" href="http://dotmobo.github.io">.mobo</a>
      </h1>
      <h3 class="header-text">Blog d'un Pythoniste Djangonaute</h3>
      <ul class="header-menu list-inline">
          <li><a class="nodec" href="http://dotmobo.github.io/categories.html">Cat&eacute;gories</a></li>
          <li class="muted">|</li>
          <li><a class="nodec" href="http://dotmobo.github.io/tags.html">Tags</a></li>
          <li class="muted">|</li>
          <li><a class="nodec" href="http://dotmobo.github.io/archives.html">Archives</a></li>
          <li class="muted">|</li>
          <li><a class="nodec icon-github" href="https://github.com/dotmobo"></a></li>
          <li><a class="nodec icon-twitter" href="https://twitter.com/dotmobo"></a></li>
          <li><a class="nodec icon-gplus" href="https://www.google.com/+DotmoboGithubIo6"></a></li>
          <li><a class="nodec icon-rss" href="/feeds/all.atom.xml"></a></li>
      </ul>
    </div>
  </div>
</header> <!-- /.header -->  <div class="container">
  <div class="post full-post">
    <h1 class="post-title">
      <a href="/django-simple-captcha.html" title="Permalink to Ajouter un captcha dans un formulaire django">Ajouter un captcha dans un formulaire django</a>
    </h1>
    <ul class="list-inline">
      <li class="post-date">
        <a class="text-muted" href="/django-simple-captcha.html" title="2015-11-28T00:00:00+01:00">sam. 28 novembre 2015</a>
      </li>
      <li class="muted">&middot;</li>
      <li class="post-category">
        <a href="http://dotmobo.github.io/category/django.html">Django</a>
      </li>
        <li class="muted">&middot;</li>
        <li>
            <a href="/tag/python.html">python</a>,             <a href="/tag/django.html">django</a>,             <a href="/tag/django-simple-captcha.html">django-simple-captcha</a>,             <a href="/tag/captcha.html">captcha</a>,             <a href="/tag/crispy.html">crispy</a>,             <a href="/tag/django-crispy.html">django-crispy</a>,             <a href="/tag/recaptcha.html">recaptcha</a>        </li>
    </ul>
    <div class="post-content">
      <img alt="Django" class="align-right" src="./images/djangopony.png" />
<p>Suite à <a class="reference external" href="http://dotmobo.github.io/django-countries.html">l'article sur django-countries</a>,
on va continuer notre parcours des petits outils simples et efficaces pour améliorer nos formulaires django.</p>
<p>Avant d'aborder le gros morceau qu'est <a class="reference external" href="http://django-crispy-forms.readthedocs.org/en/latest/">django-cryspy</a>
(tu peux déjà y jeter un oeil si tu es curieux), on va parler de l'intégration de captchas sous django.</p>
<p>L'api de captcha la plus connue est sûrement <a class="reference external" href="https://www.google.com/recaptcha">reCAPTCHA</a> de google,
et il en existe une implémentation sous django baptisée <a class="reference external" href="https://github.com/praekelt/django-recaptcha">django-recaptcha</a>.</p>
<p>Mais tu ne veux peut-être pas dépendre d'un service google pour diverses raisons, en préférant
une solution autonome, simple, légère, efficace et maintenue.</p>
<p><a class="reference external" href="https://github.com/mbi/django-simple-captcha">Django-simple-captcha</a> remplit haut la main toutes ces conditions
et est même compatible python 3. Elle est customisable, s'intègre dans les formulaires django et sous
<em>django-crispy</em>. Différents types de captcha sont disponibles comme des caractères aléatoires,
des calculs mathématiques, des dictionnaires de mots.</p>
<p>Captcha utilise <em>PIL</em> et <em>Pillow</em> qui nécessitent certaines librairies systèmes.
Par exemple sous Ubuntu, tu fais:</p>
<div class="highlight"><pre>apt-get -y install libz-dev libjpeg-dev libfreetype6-dev
</pre></div>
<p>Tu l'installes comme d'habitude avec pip:</p>
<div class="highlight"><pre>pip install django-simple-captcha
</pre></div>
<p>Et tu ajoutes <strong>captcha</strong> dans la liste de tes <strong>INSTALLED_APPS</strong>
dans le fichier <em>settings.py</em> de django:</p>
<div class="highlight"><pre><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span><span class="o">...</span><span class="p">,</span>
                  <span class="n">captcha</span>
<span class="p">)</span>
</pre></div>
<p>Tu synchronises ta base de données:</p>
<div class="highlight"><pre>python manage.py migrate
</pre></div>
<p>Et tu ajoutes l'entrée suivante dans ton fichier <strong>urls.py</strong>:</p>
<div class="highlight"><pre><span class="n">urlpatterns</span> <span class="o">+=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^captcha/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">&#39;captcha.urls&#39;</span><span class="p">)),</span>
<span class="p">)</span>
</pre></div>
<p>Il ne reste plus qu'à l'intégrer dans ton formulaire.</p>
<ul class="simple">
<li>Soit dans un <strong>Form</strong>:</li>
</ul>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">captcha.fields</span> <span class="kn">import</span> <span class="n">CaptchaField</span>

<span class="k">class</span> <span class="nc">CaptchaTestForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">myfield</span> <span class="o">=</span> <span class="n">AnyOtherField</span><span class="p">()</span>
    <span class="n">captcha</span> <span class="o">=</span> <span class="n">CaptchaField</span><span class="p">()</span>
</pre></div>
<ul class="simple">
<li>Soit dans un <strong>ModelForm</strong>:</li>
</ul>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">captcha.fields</span> <span class="kn">import</span> <span class="n">CaptchaField</span>

<span class="k">class</span> <span class="nc">CaptchaTestModelForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="n">captcha</span> <span class="o">=</span> <span class="n">CaptchaField</span><span class="p">()</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span>
</pre></div>
<p>Et sous <em>django-crispy</em>, tu peux utiliser <strong>captcha</strong> comme un <strong>Field</strong> à déclarer dans le <strong>Layout</strong>:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">captcha.fields</span> <span class="kn">import</span> <span class="n">CaptchaField</span>
<span class="kn">from</span> <span class="nn">crispy_forms.helper</span> <span class="kn">import</span> <span class="n">FormHelper</span>
<span class="kn">from</span> <span class="nn">crispy_forms.layout</span> <span class="kn">import</span> <span class="n">Layout</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">Submit</span>

<span class="k">class</span> <span class="nc">CaptchaTestModelForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="n">captcha</span> <span class="o">=</span> <span class="n">CaptchaField</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">helper</span> <span class="o">=</span> <span class="n">FormHelper</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">Layout</span><span class="p">(</span>
            <span class="n">Field</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">placeholder</span><span class="o">=</span><span class="s">&quot;Enter Full Name&quot;</span><span class="p">),</span>
            <span class="n">Field</span><span class="p">(</span><span class="s">&#39;captcha &#39;</span><span class="p">,</span> <span class="n">placeholder</span><span class="o">=</span><span class="s">&quot;Enter captcha&quot;</span><span class="p">),</span>
            <span class="n">Submit</span><span class="p">(</span><span class="s">&#39;valid&#39;</span><span class="p">,</span> <span class="s">&#39;Valid&#39;</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span>
</pre></div>
<p>La validation du formulaire se fait comme d'habitude. Si la réponse au captcha
est mauvaise, une exception <strong>ValidationError</strong> sera levée:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">some_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CaptchaTestForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>

        <span class="c"># Validate the form: the captcha field will automatically</span>
        <span class="c"># check the input</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">human</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CaptchaTestForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;template.html&#39;</span><span class="p">,</span><span class="nb">locals</span><span class="p">())</span>
</pre></div>
<p>Il est également possible de faire une validation
<a class="reference external" href="http://django-simple-captcha.readthedocs.org/en/latest/usage.html#example-usage-for-ajax-form">via ajax</a>.</p>
<p>Il y a toute <a class="reference external" href="http://django-simple-captcha.readthedocs.org/en/latest/advanced.html">une série de paramètres</a>
permettant la customisation du captcha, mais il y en a surtout deux à retenir.</p>
<p>Le premier permet de choisir le type de captcha que tu veux utiliser.
Dans ton <strong>settings.py</strong>, tu peux mettre au choix:</p>
<div class="highlight"><pre><span class="c"># Random chars</span>
<span class="n">CAPTCHA_CHALLENGE_FUNCT</span> <span class="o">=</span> <span class="s">&#39;captcha.helpers.random_char_challenge&#39;</span>
<span class="c"># Simple Math</span>
<span class="n">CAPTCHA_CHALLENGE_FUNCT</span> <span class="o">=</span> <span class="s">&#39;captcha.helpers.math_challenge&#39;</span>
<span class="c"># Dictionary Word</span>
<span class="n">CAPTCHA_CHALLENGE_FUNCT</span> <span class="o">=</span> <span class="s">&#39;captcha.helpers.word_challenge&#39;</span>
</pre></div>
<p>Tu peux même créer <a class="reference external" href="http://django-simple-captcha.readthedocs.org/en/latest/advanced.html#roll-your-own">ta propre fonction de captcha</a>
si celles proposées ne te conviennent pas.</p>
<p>Le second permet d'utiliser le captcha dans les tests unitaires. Si la chaîne de caractères <strong>PASSED</strong>
est renseignée comme valeur de réponse au captcha, le formulaire sera valide.
À mettre dans ton fichier de configuration de tes tests unitaires:</p>
<div class="highlight"><pre><span class="n">CAPTCHA_TEST_MODE</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
<p>Le résultat final ressemble à ça :</p>
<img alt="Django" class="align-left" src="http://django-simple-captcha.readthedocs.org/en/latest/_images/captcha3.png" />

    </div>
  </div>
  <hr class="separator">
  <div class="col-md-8 col-md-offset-2">
  <div id="disqus_thread">
    <script>
      var disqus_shortname = 'dotmobo';
      (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] ||
         document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>
      Activez Javascript pour voir 
      <a href="https://disqus.com/?ref_noscript=dotmobo">
        les commentaires Disqus.
      </a>
    </noscript>
    <a href="https://disqus.com" class="dsq-brlink">
      Commentaires de blog par <span class="logo-disqus">Disqus</span>
    </a>
  </div>
  </div>
  </div>
<footer class="footer">
  <div class="container">
    <p class="text-center">
      dotmobo, <a href="https://opensource.org/licenses/MIT" target="_blank">MIT</a>.
    </p>
    <div class="text-center">
      G&eacute;n&eacute;r&eacute; par <a href="http://getpelican.com" target="_blank">Pelican</a> avec le th&egrave;me <a href="https://github.com/dotmobo/pelican-alchemy">alchemy</a>.
    </div>
  </div>
</footer> <!-- /.footer -->
  <script src="http://dotmobo.github.io/theme/js/jquery.min.js"></script>
  <script src="http://dotmobo.github.io/theme/js/bootstrap.min.js"></script>
</body> <!-- 42 -->

</html>