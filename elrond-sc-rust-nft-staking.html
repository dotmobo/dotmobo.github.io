
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://dotmobo.github.io/theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark), (prefers-color-scheme: no-preference)"
    href="https://dotmobo.github.io/theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark), (prefers-color-scheme: no-preference)"
          href="https://dotmobo.github.io/theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light)"
          href="https://dotmobo.github.io/theme/pygments/emacs.min.css">


  <link rel="stylesheet" type="text/css" href="https://dotmobo.github.io/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://dotmobo.github.io/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://dotmobo.github.io/theme/font-awesome/css/solid.css">

    <link href="https://dotmobo.github.io/css/custom.css" rel="stylesheet">




<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-68852219-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->
    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#333333">

<meta name="author" content="Morgan" />
<meta name="description" content="Smart Contract Elrond en Rust : NFT staking" />
<meta name="keywords" content="elrond, rust, nft, staking">


<meta property="og:site_name" content=".mobo"/>
<meta property="og:title" content="Smart Contract Elrond en Rust : NFT staking"/>
<meta property="og:description" content="Smart Contract Elrond en Rust : NFT staking"/>
<meta property="og:locale" content="fr_FR"/>
<meta property="og:url" content="https://dotmobo.github.io/elrond-sc-rust-nft-staking.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2022-07-07 00:00:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://dotmobo.github.io/author/morgan.html">
<meta property="article:section" content="Rust"/>
<meta property="article:tag" content="elrond"/>
<meta property="article:tag" content="rust"/>
<meta property="article:tag" content="nft"/>
<meta property="article:tag" content="staking"/>
<meta property="og:image" content="//dotmobo.github.io/images/avatar700.jpg">

  <title>.mobo &ndash; Smart Contract Elrond en Rust : NFT staking</title>

</head>
<body >
  <aside>
    <div>
      <a href="https://dotmobo.github.io">
        <img src="//dotmobo.github.io/images/avatar700.jpg" alt=".mobo" title=".mobo">
      </a>

      <h1>
        <a href="https://dotmobo.github.io">.mobo</a>
      </h1>

<p>Explorations d'un développeur</p>


      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/dotmobo" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-twitter" href="https://twitter.com/dotmobo" target="_blank">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
          <li>
            <a  class="sc-rss" href="//dotmobo.github.io/feeds/all.atom.xml" target="_blank">
              <i class="fas fa-rss"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="https://dotmobo.github.io">Accueil</a>

      <a href="/categories.html">Catégories</a>
      <a href="/tags.html">Tags</a>
      <a href="/archives.html">Archives</a>


    </nav>

<article class="single">
  <header>
      
    <h1 id="elrond-sc-rust-nft-staking">Smart Contract Elrond en Rust : NFT staking</h1>
    <p>
      Posté le 07/07/2022 dans <a href="https://dotmobo.github.io/category/rust.html">Rust</a>

    </p>
  </header>


  <div>
    <img alt="Elrond" class="align-right" src="./images/elrond.png" />
<p>Voici le deuxième épisode de cette série sur les Smart Contracts <a class="reference external" href="https://elrond.com/">Elrond</a>
en <a class="reference external" href="https://rust-lang.org/">Rust</a>. On va parler ici d'un
sujet qui intéresse pas mal de monde dans l'univers des NFTs : le <strong>staking</strong>.</p>
<p>On suppose que tu as déjà tous les outils pour te lancer dans l'aventure. Si ce n'est pas le cas, jettes un oeil
au <a class="reference external" href="http://dotmobo.github.io/elrond-sc-rust-dao-vote.html#elrond-sc-rust-dao-vote">premier épisode</a>.</p>
<div class="section" id="contexte">
<h2>Contexte</h2>
<p>C'est une version simple du staking qui est largement améliorable, mais ça permet d'avoir un premier jet
fonctionnel.</p>
<p>L'idée ici est de créer un SC qui va être une pool de staking. Chaque utilisateur va pouvoir envoyer un
NFT dans cette pool, et pourra réclamer journalièrement des tokens ESDT en récompense.</p>
<p>On a deux limitations dans cette version :</p>
<ul class="simple">
<li>Chaque utilisateur représenté par une adresse Elrond ne peut envoyer qu'un seul NFT dans la pool.</li>
<li>Les récompenses sont à réclamer régulièrement et ne sont pas directement attribuées.</li>
<li>Une seule collection de NFT est supportée. Donc pour faire une pool de staking sur une autre collection, il
faudra déployer un deuxième SC.</li>
</ul>
<p>Dans ta <strong>dapp</strong>, ça pourra ressembler à ça par exemple :</p>
<img alt="Elrond" src="./images/staking.png" />
</div>
<div class="section" id="smart-contract">
<h2>Smart Contract</h2>
<p>Comme dans le premier épisode, on crée un SC vide à l'aide de <strong>erdpy</strong>.</p>
<div class="highlight"><pre><span></span>erdpy<span class="w"> </span>contract<span class="w"> </span>new<span class="w"> </span>staking<span class="w"> </span>--template<span class="w"> </span>empty
</pre></div>
<p>Ensuite, dans un fichier <strong>src/stake_info.rs</strong>, on va avoir notre structure qui nous permettra de stocker les
informations de staking de l'utilisateur.</p>
<div class="highlight"><pre><span></span><span class="n">elrond_wasm</span><span class="p">::</span><span class="n">imports</span><span class="o">!</span><span class="p">();</span>
<span class="n">elrond_wasm</span><span class="p">::</span><span class="n">derive_imports</span><span class="o">!</span><span class="p">();</span>

<span class="cp">#[derive(TypeAbi, TopEncode, TopDecode, PartialEq, Debug)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">StakeInfo</span><span class="o">&lt;</span><span class="n">M</span><span class="p">:</span><span class="w"> </span><span class="nc">ManagedTypeApi</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="nc">ManagedAddress</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_nonce</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">lock_time</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">unstake_time</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
<p>On y stocke donc :</p>
<ul class="simple">
<li>son adresse Elrond.</li>
<li>le <strong>nonce</strong> de son NFT, qui représente le numéro du NFT dans la collection.</li>
<li>le moment où le NFT est locké, c-à-d quand il est envoyé dans la pool.</li>
<li>le moment où le NFT peut être déstaker via <strong>unstake_time</strong>.</li>
</ul>
<p>On passe ensuite à l'écriture du SC dans <strong>src/empty.rs</strong>.</p>
<p>On initialise les différents arguments de notre SC via la fonction <strong>init</strong>.</p>
<ul class="simple">
<li><em>nft_identifier</em> : l'identifiant de la collection NFT concernée.</li>
<li><em>minimum_staking_days</em> : le nombre de jours minimum avant de pouvoir déstaker son NFT.</li>
<li><em>rewards_token_id</em> : l'identifiant du token ESDT pour les récompenses.</li>
<li><em>rewards_token_amount_per_day</em> : le montant par jour des récompenses du staking.</li>
<li><em>rewards_token_total_supply</em> : le nombre total de tokens disponibles dans le SC.</li>
</ul>
<p>Et on initie quelques paramètres supplémentaires comme :</p>
<ul class="simple">
<li><em>staking_status</em> : permet de définir si la pool est démarrée où non.</li>
<li><em>staking_end_time</em> : permet de définir le moment où la pool sera fermée.</li>
<li><em>nbr_of_stakers</em> : permet de définir le nombre de stakers dans la pool.</li>
</ul>
<div class="highlight"><pre><span></span><span class="cp">#![no_std]</span>

<span class="n">elrond_wasm</span><span class="p">::</span><span class="n">imports</span><span class="o">!</span><span class="p">();</span>

<span class="k">mod</span><span class="w"> </span><span class="nn">stake_info</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">stake_info</span><span class="p">::</span><span class="n">StakeInfo</span><span class="p">;</span>

<span class="cp">#[elrond_wasm::contract]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">NftStaking</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cp">#[init]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_identifier</span><span class="p">:</span><span class="w"> </span><span class="nc">TokenIdentifier</span><span class="p">,</span>
<span class="w">        </span><span class="n">minimum_staking_days</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="w">        </span><span class="n">rewards_token_id</span><span class="p">:</span><span class="w"> </span><span class="nc">TokenIdentifier</span><span class="p">,</span>
<span class="w">        </span><span class="n">rewards_token_amount_per_day</span><span class="p">:</span><span class="w"> </span><span class="nc">BigUint</span><span class="p">,</span>
<span class="w">        </span><span class="n">rewards_token_total_supply</span><span class="p">:</span><span class="w"> </span><span class="nc">BigUint</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">nft_identifier</span><span class="p">().</span><span class="n">set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nft_identifier</span><span class="p">);</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">minimum_staking_days</span><span class="p">().</span><span class="n">set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minimum_staking_days</span><span class="p">);</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">rewards_token_id</span><span class="p">().</span><span class="n">set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rewards_token_id</span><span class="p">);</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">rewards_token_amount_per_day</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rewards_token_amount_per_day</span><span class="p">);</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">rewards_token_total_supply</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rewards_token_total_supply</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// if staking status is empty, set it to false</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_status</span><span class="p">().</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_status</span><span class="p">().</span><span class="n">set</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// if staking end time is empty, set it to 0</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_end_time</span><span class="p">().</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_end_time</span><span class="p">().</span><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// if nbr of stakers is empty, set it to 0</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">nbr_of_stakers</span><span class="p">().</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">nbr_of_stakers</span><span class="p">().</span><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Tu peux alors définir les <strong>storage_mapper</strong> et les <strong>view</strong> pour ces différents paramètres.
Le <strong>storage_mapper</strong> appelé <strong>staking_info</strong> va permettre de stoker un objet <strong>StakeInfo</strong>
par adresse Elrond via la définition <strong>SingleValueMapper&lt;StakeInfo&lt;Self::Api&gt;&gt;</strong>.</p>
<div class="highlight"><pre><span></span><span class="cp">#[view(getNftIdentifier)]</span>
<span class="cp">#[storage_mapper(</span><span class="s">&quot;nft_identifier&quot;</span><span class="cp">)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">nft_identifier</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">SingleValueMapper</span><span class="o">&lt;</span><span class="n">TokenIdentifier</span><span class="o">&gt;</span><span class="p">;</span>

<span class="cp">#[view(getMinimumStakingDays)]</span>
<span class="cp">#[storage_mapper(</span><span class="s">&quot;minimum_staking_days&quot;</span><span class="cp">)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">minimum_staking_days</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">SingleValueMapper</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">;</span>

<span class="cp">#[view(getRewardsTokenId)]</span>
<span class="cp">#[storage_mapper(</span><span class="s">&quot;rewards_token_id&quot;</span><span class="cp">)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">rewards_token_id</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">SingleValueMapper</span><span class="o">&lt;</span><span class="n">TokenIdentifier</span><span class="o">&gt;</span><span class="p">;</span>

<span class="cp">#[view(getRewardsTokenAmountPerDay)]</span>
<span class="cp">#[storage_mapper(</span><span class="s">&quot;rewards_token_amount_per_day&quot;</span><span class="cp">)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">rewards_token_amount_per_day</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">SingleValueMapper</span><span class="o">&lt;</span><span class="n">BigUint</span><span class="o">&gt;</span><span class="p">;</span>

<span class="cp">#[view(getStakingInfo)]</span>
<span class="cp">#[storage_mapper(</span><span class="s">&quot;staking_info&quot;</span><span class="cp">)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">staking_info</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">ManagedAddress</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">SingleValueMapper</span><span class="o">&lt;</span><span class="n">StakeInfo</span><span class="o">&lt;</span><span class="bp">Self</span><span class="p">::</span><span class="n">Api</span><span class="o">&gt;&gt;</span><span class="p">;</span>

<span class="cp">#[view(getStakingStatus)]</span>
<span class="cp">#[storage_mapper(</span><span class="s">&quot;staking_status&quot;</span><span class="cp">)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">staking_status</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">SingleValueMapper</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">;</span>

<span class="cp">#[view(getStakingEndTime)]</span>
<span class="cp">#[storage_mapper(</span><span class="s">&quot;staking_end_time&quot;</span><span class="cp">)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">staking_end_time</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">SingleValueMapper</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">;</span>

<span class="cp">#[view(getRewardsTokenTotalSupply)]</span>
<span class="cp">#[storage_mapper(</span><span class="s">&quot;rewards_token_total_supply&quot;</span><span class="cp">)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">rewards_token_total_supply</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">SingleValueMapper</span><span class="o">&lt;</span><span class="n">BigUint</span><span class="o">&gt;</span><span class="p">;</span>

<span class="cp">#[view(getNbrOfStakers)]</span>
<span class="cp">#[storage_mapper(</span><span class="s">&quot;nbr_of_stakers&quot;</span><span class="cp">)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">nbr_of_stakers</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">SingleValueMapper</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
<p>On passe ensuite à la fonction de staking. Celle-ci doit être <strong>payable</strong> car on y envoit son NFT.
Il faut vérifier le que le staking est démarré et que le NFT envoyé est bien dans la collection.
On vérifie aussi qu'un NFT n'est pas déjà locké par cet utilisateur.</p>
<p>On définit alors les différents paramètres de son <strong>StakeInfo</strong> que l'on sauvegarde dans la blockchain
et on incrémente le <strong>nbr_of_stakers</strong>. On ajoute également le moment où il pourra déstaker son NFT.</p>
<p>Ne pas oublier le <strong>Ok(())</strong> à la fin !</p>
<div class="highlight"><pre><span></span><span class="cp">#[payable(</span><span class="s">&quot;*&quot;</span><span class="cp">)]</span>
<span class="cp">#[endpoint]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">stake</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">SCResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">payment</span><span class="p">:</span><span class="w"> </span><span class="nc">EsdtTokenPayment</span><span class="o">&lt;</span><span class="bp">Self</span><span class="p">::</span><span class="n">Api</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">call_value</span><span class="p">().</span><span class="n">payment</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">payment_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">payment</span><span class="p">.</span><span class="n">token_identifier</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">payment_nonce</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">payment</span><span class="p">.</span><span class="n">token_nonce</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">payment_amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">payment</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
<span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">staking_status</span><span class="p">().</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;The staking is stopped&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span>
<span class="w">        </span><span class="n">payment_token</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">nft_identifier</span><span class="p">().</span><span class="n">get</span><span class="p">(),</span>
<span class="w">        </span><span class="s">&quot;Invalid nft identifier&quot;</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span><span class="n">payment_nonce</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Invalid nft nonce&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span><span class="n">payment_amount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;You can only send 1 nft&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">caller</span><span class="p">:</span><span class="w"> </span><span class="nc">ManagedAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">blockchain</span><span class="p">().</span><span class="n">get_caller</span><span class="p">();</span>

<span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">caller</span><span class="p">).</span><span class="n">is_empty</span><span class="p">(),</span>
<span class="w">        </span><span class="s">&quot;You have already staked.&quot;</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cur_time</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">blockchain</span><span class="p">().</span><span class="n">get_block_timestamp</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">unstake_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">minimum_staking_days</span><span class="p">().</span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">86400</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stake_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StakeInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="nc">self</span><span class="p">.</span><span class="n">blockchain</span><span class="p">().</span><span class="n">get_caller</span><span class="p">(),</span>
<span class="w">        </span><span class="n">nft_nonce</span><span class="p">:</span><span class="w"> </span><span class="nc">payment_nonce</span><span class="p">,</span>
<span class="w">        </span><span class="n">lock_time</span><span class="p">:</span><span class="w"> </span><span class="nc">cur_time</span><span class="p">,</span>
<span class="w">        </span><span class="n">unstake_time</span><span class="p">:</span><span class="w"> </span><span class="nc">unstake_time</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_info</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">blockchain</span><span class="p">().</span><span class="n">get_caller</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stake_info</span><span class="p">);</span>

<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">nbr_of_stakers</span><span class="p">().</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">nbr_of_stakers</span><span class="p">().</span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></div>
<p>Notre utilisateur peut désormais staker son NFT. Maintenant il faut qu'il puisse le déstaker.
On vérifie qu'il a bien un <strong>StakeInfo</strong> stocké dans la blockchain avec son adresse et qu'il a bien
dépassé le nombre minimum de jours de staking.</p>
<p>Si c'est le cas, on lui envoie son NFT via <strong>self.send().direct()</strong>, on supprime son entrée <strong>StakeInfo</strong>
et on décrémente le <strong>nbr_of_stakers</strong>.</p>
<div class="highlight"><pre><span></span><span class="cp">#[endpoint]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">unstake</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">SCResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">caller</span><span class="p">:</span><span class="w"> </span><span class="nc">ManagedAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">blockchain</span><span class="p">().</span><span class="n">get_caller</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cur_time</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">blockchain</span><span class="p">().</span><span class="n">get_block_timestamp</span><span class="p">();</span>

<span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">staking_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">caller</span><span class="p">).</span><span class="n">is_empty</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;You didn&#39;t stake!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stake_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">caller</span><span class="p">).</span><span class="n">get</span><span class="p">();</span>
<span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span>
<span class="w">        </span><span class="n">stake_info</span><span class="p">.</span><span class="n">unstake_time</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">cur_time</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;You can&#39;t unlock staking nft yet.&quot;</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">nft_identifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">nft_identifier</span><span class="p">().</span><span class="n">get</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">nft_nonce</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stake_info</span><span class="p">.</span><span class="n">nft_nonce</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BigUint</span><span class="p">::</span><span class="n">from</span><span class="p">(</span><span class="mi">1</span><span class="k">u32</span><span class="p">);</span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">send</span><span class="p">().</span><span class="n">direct</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">caller</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">nft_identifier</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_nonce</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">amount</span><span class="p">,</span>
<span class="w">        </span><span class="s">b&quot;unstake successful&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">caller</span><span class="p">).</span><span class="n">clear</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">nbr_of_stakers</span><span class="p">().</span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">nbr_of_stakers</span><span class="p">().</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">nbr_of_stakers</span><span class="p">().</span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></div>
<p>Troisème grosse étape après le staking et le déstaking : la possibilté de réclamer ses récompenses.
On calcule ses récompenses en fonction du nombre de jours de staking et du moment où il a locké son NFT.
On vérifie également qu'il reste bien des tokens disponibles dans le SC.</p>
<p>Après avoir envoyé ses récompenses, on met à jour son <strong>StakeInfo</strong> en redéfinissant son <strong>lock time</strong>
à maintenant. Ce qui va permet de relancer le calcul des futurs récompenses à partir de là.</p>
<div class="highlight"><pre><span></span><span class="cp">#[endpoint]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">claim</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">SCResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">caller</span><span class="p">:</span><span class="w"> </span><span class="nc">ManagedAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">blockchain</span><span class="p">().</span><span class="n">get_caller</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cur_time</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">blockchain</span><span class="p">().</span><span class="n">get_block_timestamp</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rewards_token_total_supply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">rewards_token_total_supply</span><span class="p">().</span><span class="n">get</span><span class="p">();</span>

<span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">staking_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">caller</span><span class="p">).</span><span class="n">is_empty</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;You didn&#39;t stake!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stake_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">caller</span><span class="p">).</span><span class="n">get</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">nft_nonce</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stake_info</span><span class="p">.</span><span class="n">nft_nonce</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">unstake_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stake_info</span><span class="p">.</span><span class="n">unstake_time</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">reward_token_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">rewards_token_id</span><span class="p">().</span><span class="n">get</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// calculate rewards</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">from_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur_time</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">staking_status</span><span class="p">().</span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">from_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_end_time</span><span class="p">().</span><span class="n">get</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">staked_days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="k">u64</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">from_time</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">stake_info</span><span class="p">.</span><span class="n">lock_time</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">staked_days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">from_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">stake_info</span><span class="p">.</span><span class="n">lock_time</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">86400</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rewards_amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">rewards_token_amount_per_day</span><span class="p">().</span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">staked_days</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// check the supply</span>
<span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span>
<span class="w">        </span><span class="n">rewards_amount</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rewards_token_total_supply</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;You can&#39;t claim rewards more than total supply.&quot;</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// send rewards</span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">send</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">direct</span><span class="p">(</span><span class="o">&amp;</span><span class="n">caller</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">reward_token_id</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rewards_amount</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[]);</span>

<span class="w">    </span><span class="c1">// remove rewards amount from rewards_token_total_supply</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">rewards_token_total_supply</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">rewards_amount</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">rewards_token_total_supply</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">rewards_token_total_supply</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rewards_amount</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">rewards_token_total_supply</span><span class="p">().</span><span class="n">set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BigUint</span><span class="p">::</span><span class="n">from</span><span class="p">(</span><span class="mi">0</span><span class="k">u32</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// update staking_info</span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">caller</span><span class="p">).</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stake_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StakeInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="nc">self</span><span class="p">.</span><span class="n">blockchain</span><span class="p">().</span><span class="n">get_caller</span><span class="p">(),</span>
<span class="w">        </span><span class="n">nft_nonce</span><span class="p">:</span><span class="w"> </span><span class="nc">nft_nonce</span><span class="p">,</span>
<span class="w">        </span><span class="n">lock_time</span><span class="p">:</span><span class="w"> </span><span class="nc">from_time</span><span class="p">,</span>
<span class="w">        </span><span class="n">unstake_time</span><span class="p">:</span><span class="w"> </span><span class="nc">unstake_time</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_info</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">blockchain</span><span class="p">().</span><span class="n">get_caller</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stake_info</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></div>
<p>Le plus gros est fait ! On ajoute quelques fonctions d'administration supplémentaires pour le possesseur du
SC, à savoir :</p>
<ul class="simple">
<li><em>set_rewards_token_total_supply</em> : pour définir le nombre total de tokens disponibles dans la pool pour récompenser
les utilisateurs.</li>
<li><em>set_rewards_token_amount_per_day</em> : la possibilité de modifier le nombre de récompenses journalières.</li>
<li><em>withdraw</em> : la possibilité de récupérer tous les tokens du SC, au cas où.</li>
<li><em>stop_staking</em> : la possibilité de stopper le staking.</li>
<li><em>restart_staking</em> : la possibilité de relancer le staking.</li>
</ul>
<div class="highlight"><pre><span></span><span class="cp">#[only_owner]</span>
<span class="cp">#[endpoint]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">set_rewards_token_total_supply</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">total_supply</span><span class="p">:</span><span class="w"> </span><span class="nc">BigUint</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">SCResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">rewards_token_total_supply</span><span class="p">().</span><span class="n">set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">total_supply</span><span class="p">);</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="c1">// set rewards_token_amount_per_day</span>
<span class="cp">#[only_owner]</span>
<span class="cp">#[endpoint]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">set_rewards_token_amount_per_day</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">:</span><span class="w"> </span><span class="nc">BigUint</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">SCResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">rewards_token_amount_per_day</span><span class="p">().</span><span class="n">set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amount</span><span class="p">);</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="cp">#[only_owner]</span>
<span class="cp">#[endpoint]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">withdraw</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">:</span><span class="w"> </span><span class="nc">BigUint</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">SCResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">caller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">blockchain</span><span class="p">().</span><span class="n">get_caller</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">token_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">rewards_token_id</span><span class="p">().</span><span class="n">get</span><span class="p">();</span>

<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">send</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">direct</span><span class="p">(</span><span class="o">&amp;</span><span class="n">caller</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">token_id</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="s">b&quot;withdraw successful&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="cp">#[only_owner]</span>
<span class="cp">#[endpoint]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">restart_staking</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">SCResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_end_time</span><span class="p">().</span><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_status</span><span class="p">().</span><span class="n">set</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="cp">#[only_owner]</span>
<span class="cp">#[endpoint]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">stop_staking</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">SCResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cur_time</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">blockchain</span><span class="p">().</span><span class="n">get_block_timestamp</span><span class="p">();</span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_end_time</span><span class="p">().</span><span class="n">set</span><span class="p">(</span><span class="n">cur_time</span><span class="p">);</span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_status</span><span class="p">().</span><span class="n">set</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></div>
<p>Enfin, tu peux ajouter quelques vues qui seront utiles pour l'affichage dans ta <strong>dapp</strong>.</p>
<ul class="simple">
<li><em>get_current_rewards</em> : pour afficher le montant des récompenses récupérables actuellement.</li>
<li><em>get_nft_nonce</em> : pour afficher le numéro du NFT que l'utilisateur a locké.</li>
<li><em>get_lock_time</em> : pour afficher le moment où l'utilisateur a locké son NFT.</li>
<li><em>get_unstake_time</em> : pour afficher le moment où l'utilisateur peut déstaker son NFT.</li>
</ul>
<div class="highlight"><pre><span></span><span class="cp">#[view(getCurrentRewards)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">get_current_rewards</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">ManagedAddress</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">BigUint</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">staking_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address</span><span class="p">).</span><span class="n">is_empty</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;You didn&#39;t stake!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cur_time</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">blockchain</span><span class="p">().</span><span class="n">get_block_timestamp</span><span class="p">();</span>

<span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">staking_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address</span><span class="p">).</span><span class="n">is_empty</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;You didn&#39;t stake!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stake_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address</span><span class="p">).</span><span class="n">get</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// calculate rewards</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">from_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur_time</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">staking_status</span><span class="p">().</span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">from_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_end_time</span><span class="p">().</span><span class="n">get</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">staked_days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="k">u64</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">from_time</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">stake_info</span><span class="p">.</span><span class="n">lock_time</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">staked_days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">from_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">stake_info</span><span class="p">.</span><span class="n">lock_time</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">86400</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rewards_amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">rewards_token_amount_per_day</span><span class="p">().</span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">staked_days</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">rewards_amount</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#[view(getNftNonce)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">get_nft_nonce</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">ManagedAddress</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">staking_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address</span><span class="p">).</span><span class="n">is_empty</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;You didn&#39;t stake!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stake_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address</span><span class="p">).</span><span class="n">get</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">nft_nonce</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stake_info</span><span class="p">.</span><span class="n">nft_nonce</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">nft_nonce</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#[view(getLockTime)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">get_lock_time</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">ManagedAddress</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">staking_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address</span><span class="p">).</span><span class="n">is_empty</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;You didn&#39;t stake!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stake_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address</span><span class="p">).</span><span class="n">get</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">lock_time</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stake_info</span><span class="p">.</span><span class="n">lock_time</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">lock_time</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#[view(getUnstakeTime)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">get_unstake_time</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">ManagedAddress</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">staking_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address</span><span class="p">).</span><span class="n">is_empty</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;You didn&#39;t stake!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stake_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">staking_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address</span><span class="p">).</span><span class="n">get</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">unstake_time</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stake_info</span><span class="p">.</span><span class="n">unstake_time</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">unstake_time</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>Tu utilises alors à nouveau <strong>erdpy</strong> pour compiler ton SC et vérifier que tout se passe bien :</p>
<div class="highlight"><pre><span></span>erdpy<span class="w"> </span>contract<span class="w"> </span>build
</pre></div>
<p>Le code final est visible <a class="reference external" href="https://github.com/dotmobo/dbc-dashboard/blob/master/contract/nft_staking/src/empty.rs">ici</a>.</p>
</div>
<div class="section" id="deploiement">
<h2>Déploiement</h2>
<p>Pour déployer, il te faut un fichier <strong>erdpy.json</strong> à la racine du projet. Comme pour l'épisode précédent,
on va déployer sur <strong>devnet</strong> et on suppose que le <strong>pem</strong> de ton <strong>wallet</strong> est dans <strong>../../wallet/wallet-owner.pem</strong>.</p>
<p>Concernant les arguments ici :</p>
<ul class="simple">
<li><em>BACKGROUND-35c061</em> : l'id de la collection NFT concernée</li>
<li><em>10</em> : nombre de jours minimum de staking</li>
<li><em>DEADBROS-fa8f0f</em> : l'id de l'ESDT utilisé pour les récompenses</li>
<li><em>100000000000000000000</em> : le montant journalier des récompenses. C'est sur 18 décimals, donc en vrai on a 100 $DEAD de récompenses.</li>
<li><em>6000000000000000000000000</em> : le nombre total de tokens disponibles dans le SC. 6 millions donc.</li>
</ul>
<div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;configurations&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;default&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;proxy&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://devnet-api.elrond.com&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;chainID&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;D&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;contract&quot;</span><span class="p">:{</span>
<span class="w">        </span><span class="nt">&quot;deploy&quot;</span><span class="p">:{</span>
<span class="w">            </span><span class="nt">&quot;verbose&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;bytecode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;output/nft_staking.wasm&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;recall-nonce&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;metadata-payable&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;pem&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;../../wallet/wallet-owner.pem&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;gas-limit&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">59999999</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;arguments&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;str:BACKGROUND-35c061&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;10&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;str:DEADBROS-fa8f0f&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;100000000000000000000&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;6000000000000000000000000&quot;</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;send&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;outfile&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;deploy-testnet.interaction.json&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;upgrade&quot;</span><span class="p">:{</span>
<span class="w">            </span><span class="nt">&quot;verbose&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;bytecode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;output/nft_staking.wasm&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;recall-nonce&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;metadata-payable&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;pem&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;../../wallet/wallet-owner.pem&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;gas-limit&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">59999999</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;arguments&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;str:BACKGROUND-35c061&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;10&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;str:DEADBROS-fa8f0f&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;100000000000000000000&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;6000000000000000000000000&quot;</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;send&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;outfile&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;deploy-testnet.interaction.json&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Le SC doit être payable via <strong>&quot;metadata-payable&quot;: true</strong>, car ça va nous permettre d'y envoyer directement
le nombre total de tokens pour les récompenses via une transaction standard avec Maiar.</p>
<p>Tu peux alors déployer et tester les transactions avec <strong>erdpy</strong>.</p>
<div class="highlight"><pre><span></span>erdpy<span class="w"> </span>contract<span class="w"> </span>deploy
erdpy<span class="w"> </span>tx<span class="w"> </span>new<span class="w"> </span>--help
</pre></div>
<p>Il ne te reste plus qu'à coder <a class="reference external" href="https://github.com/dotmobo/dbc-dashboard/blob/master/dapp/src/components/NftStaking/index.tsx">une interface frontend pour le SC</a>.</p>
<p>Bon courage ! Et n'hésite pas à améliorer tout ça et à nous faire un retour !</p>
</div>

  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://dotmobo.github.io/tag/elrond.html">elrond</a>
      <a href="https://dotmobo.github.io/tag/rust.html">rust</a>
      <a href="https://dotmobo.github.io/tag/nft.html">nft</a>
      <a href="https://dotmobo.github.io/tag/staking.html">staking</a>
    </p>
  </div>





<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'dotmobo';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Veuillez activer le JavaScript pour voir les commentaires.
</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>
  &copy; 2018  - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>
Construit avec <a href="http://getpelican.com" target="_blank">Pelican</a> utilisant le thème <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a>
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="https://dotmobo.github.io/theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="dark"
          type="text/javascript">
  </script>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " .mobo ",
  "url" : "https://dotmobo.github.io",
  "image": "//dotmobo.github.io/images/avatar700.jpg",
  "description": ".mobo - explorations d'un développeur"
}
</script>


</body>
</html>